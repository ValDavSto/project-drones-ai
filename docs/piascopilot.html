<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-07-10T10:08:33.9385965"><title>Pi as Co-Pilot | Drone Project</title><script type="application/json" id="virtual-toc-data">[{"id":"overview","level":0,"title":"Overview","anchor":"#overview"},{"id":"hardware-setup","level":0,"title":"Hardware Setup","anchor":"#hardware-setup"},{"id":"software-architecture","level":0,"title":"Software Architecture","anchor":"#software-architecture"},{"id":"msp-communication-module","level":0,"title":"MSP Communication Module","anchor":"#msp-communication-module"},{"id":"co-pilot-flight-logic","level":0,"title":"Co-Pilot Flight Logic","anchor":"#co-pilot-flight-logic"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Pi as Co-Pilot | Drone Project"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Drone Project Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/piascopilot.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Pi as Co-Pilot | Drone Project"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/piascopilot.html#webpage",
    "url": "writerside-documentation/piascopilot.html",
    "name": "Pi as Co-Pilot | Drone Project",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Drone Project Help"
}</script><!-- End Schema.org --></head><body data-id="PiAsCoPilot" data-main-title="Pi as Co-Pilot" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs=""><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Drone Project  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="PiAsCoPilot" id="PiAsCoPilot.md">Pi as Co-Pilot</h1><p id="-wjjj4m_3">This section describes how we utilize a Raspberry Pi Zero 2W as an intelligent co-pilot for our drone system. The Raspberry Pi communicates with the Betaflight flight controller using the MultiWii Serial Protocol (MSP) over a UART interface. This setup enables semi-autonomous flight behavior while maintaining full compatibility with manual pilot inputs.</p><section class="chapter"><h2 id="overview" data-toc="overview">Overview</h2><p id="-wjjj4m_10">The Raspberry Pi serves as an auxiliary flight control unit that interacts with the main flight controller. It sends RC commands and reads telemetry data using MSP over a serial interface. Depending on the flight mode selected via the Betaflight AUX3 channel, the Pi executes different behaviors.</p><p id="-wjjj4m_11">There are two main operational modes:</p><ul class="list _bullet" id="-wjjj4m_12"><li class="list__item" id="-wjjj4m_15"><p id="-wjjj4m_18"><span class="control" id="-wjjj4m_19">Stable Hover &amp; Object Detection Mode</span> (<code class="code" id="-wjjj4m_20">AUX3: 1300&ndash;1800</code>): <br> In this mode, the Pi takes control of the flight sticks to maintain a stable and level hover. It continuously sends neutral RC values to keep the drone steady in the air. At the same time, it scans for red objects using the onboard camera, as described in <a href="red-object-detection-code.html" id="-wjjj4m_22" data-tooltip="This Python script captures images from a Raspberry Pi camera using PiCamera2 and analyzes them in real-time to detect the presence of red objects. It uses the HSV color space for more robust color detection.">Red Object Detection</a>. If a red object is detected, the Pi rotates the drone either to the left or right to align with the object. Since the Pi Cam is downward-facing, this turning motion can help position the drone precisely over the target &mdash; for example, to pick up a package using the attached magnet.</p></li><li class="list__item" id="-wjjj4m_16"></li><li class="list__item" id="-wjjj4m_17"><p id="-wjjj4m_23"><span class="control" id="-wjjj4m_24">Forward Flying Mode</span> (<code class="code" id="-wjjj4m_25">AUX3: 1800&ndash;2100</code>): <br> In this mode, the Pi commands a slight forward motion by adjusting the pitch input. This enables the drone to move ahead while still maintaining stability.</p></li></ul><aside class="prompt" data-type="tip" data-title="" id="-wjjj4m_13"><p id="-wjjj4m_27">For configuration details, refer to <a href="betaflightsetup.html" id="-wjjj4m_28" data-tooltip="This guide describes the steps we took to configure our drone using Betaflight.">Betaflight Setup</a>, which explains how to enable MSP Override mode.</p></aside></section><section class="chapter"><h2 id="hardware-setup" data-toc="hardware-setup">Hardware Setup</h2><p id="-wjjj4m_29">To establish communication between the Raspberry Pi and the flight controller, connect the two devices via a UART interface:</p><ul class="list _bullet" id="-wjjj4m_30"><li class="list__item" id="-wjjj4m_32"><p id="-wjjj4m_34"><span class="control" id="-wjjj4m_35">Raspberry Pi TX</span> &rarr; <span class="control" id="-wjjj4m_36">Flight Controller RX</span> (e.g., UART3)</p></li><li class="list__item" id="-wjjj4m_33"><p id="-wjjj4m_37"><span class="control" id="-wjjj4m_38">Raspberry Pi RX</span> &rarr; <span class="control" id="-wjjj4m_39">Flight Controller TX</span></p></li></ul><p id="-wjjj4m_31">Ensure the Pi is properly powered from the drone's power system.</p></section><section class="chapter"><h2 id="software-architecture" data-toc="software-architecture">Software Architecture</h2><p id="-wjjj4m_40">A custom Python script runs on the Raspberry Pi to handle MSP communication. This script acts as a bridge between the Pi and the Betaflight flight controller, issuing control commands and reading telemetry over a serial connection.</p><section class="chapter"><h3 id="operational-behavior" data-toc="operational-behavior">Operational Behavior</h3><p id="-wjjj4m_42">The core logic revolves around continuously monitoring the AUX channels to determine the Pi's control behavior:</p><ul class="list _bullet" id="-wjjj4m_43"><li class="list__item" id="-wjjj4m_48"><p id="-wjjj4m_51"><span class="control" id="-wjjj4m_53">AUX3</span> (Mode Selector):</p><ul class="list _bullet" id="-wjjj4m_52"><li class="list__item" id="-wjjj4m_54"><p id="-wjjj4m_57"><span class="control" id="-wjjj4m_58">&lt; 1300</span>: MSP Override is off &ndash; the Pi remains inactive.</p></li><li class="list__item" id="-wjjj4m_55"><p id="-wjjj4m_59"><span class="control" id="-wjjj4m_60">1300&ndash;1800</span>: Stable and Object Detection Mode &ndash; the Pi maintains the drone&rsquo;s current position and scans for red objects.</p></li><li class="list__item" id="-wjjj4m_56"><p id="-wjjj4m_61"><span class="control" id="-wjjj4m_62">&gt; 1800</span>: Flying Forward Mode &ndash; the Pi commands a slight forward motion.</p></li></ul></li><li class="list__item" id="-wjjj4m_49"><p id="-wjjj4m_63"><span class="control" id="-wjjj4m_64">AUX5</span>: Activates the magnet (e.g., to pick up a package).</p></li><li class="list__item" id="-wjjj4m_50"><p id="-wjjj4m_65"><span class="control" id="-wjjj4m_66">AUX6</span>: Deactivates the magnet (e.g., to release a package).</p></li></ul><p id="-wjjj4m_44">All control logic is managed through a custom <code class="code" id="-wjjj4m_67">MSP</code> class, which sends and receives MSP messages over the serial connection. This class allows us to inject RC commands while preserving the pilot's AUX settings.</p><aside class="prompt" data-type="tip" data-title="" id="-wjjj4m_45"><p id="-wjjj4m_68">For further information on payload delivery, refer to <a href="package-transportation.html" id="-wjjj4m_69" data-tooltip="Our drone is required to handle payload pickup and drop-off of a prepared package.">Package Transportation</a>.</p></aside><aside class="prompt" data-type="tip" data-title="" id="-wjjj4m_46"><p id="-wjjj4m_70">The MSP implementation in Python includes full support for packet formatting, UART communication, and RC channel synchronization.</p></aside></section></section><section class="chapter"><h2 id="msp-communication-module" data-toc="msp-communication-module">MSP Communication Module</h2><p id="-wjjj4m_71">The <code class="code" id="-wjjj4m_79">MSP</code> class abstracts the protocol details and provides high-level methods for:</p><ul class="list _bullet" id="-wjjj4m_72"><li class="list__item" id="-wjjj4m_80"><p id="-wjjj4m_83"><span class="control" id="-wjjj4m_84">Sending RC input</span> (<code class="code" id="-wjjj4m_85">send_rc</code>)</p></li><li class="list__item" id="-wjjj4m_81"><p id="-wjjj4m_86"><span class="control" id="-wjjj4m_87">Reading current RC channel values</span> (<code class="code" id="-wjjj4m_88">read_rc</code>)</p></li><li class="list__item" id="-wjjj4m_82"><p id="-wjjj4m_89"><span class="control" id="-wjjj4m_90">Sending flight control commands</span> with pitch, roll, yaw, and throttle inputs while maintaining AUX values (<code class="code" id="-wjjj4m_91">send_flight_control</code>)</p></li></ul><p id="-wjjj4m_73">This module encodes MSP packets with proper binary formatting and checksum validation to ensure robust communication. It typically operates over <code class="code" id="-wjjj4m_92">/dev/serial0</code> (Linux) or <code class="code" id="-wjjj4m_93">COMx</code> ports (Windows).</p><p id="-wjjj4m_74">Through this abstraction, the Raspberry Pi can behave like a secondary flight controller that only overrides inputs when allowed by the MSP Override switch.</p><p id="-wjjj4m_75">If <code class="code" id="-wjjj4m_94">send_rc</code> is used, only the four primary flight control inputs &mdash; roll, pitch, yaw, and throttle &mdash; can be manipulated. This is because in the <a href="betaflightsetup.html" id="-wjjj4m_95" data-tooltip="This guide describes the steps we took to configure our drone using Betaflight.">Betaflight Setup</a>, we set the <code class="code" id="-wjjj4m_96">msp_override_channels_mask</code> to <code class="code" id="-wjjj4m_97">15</code>, which corresponds to the binary value <code class="code" id="-wjjj4m_98">0000000000001111</code>. Each bit in this 16-bit mask represents one RC channel, starting with bit <code class="code" id="-wjjj4m_99">0 = roll</code>, <code class="code" id="-wjjj4m_100">bit 1 = pitch</code>, <code class="code" id="-wjjj4m_101">bit 2 = yaw</code>, <code class="code" id="-wjjj4m_102">bit 3 = throttle</code>, and so on up to channel <code class="code" id="-wjjj4m_103">15</code> (e.g., AUX channels).</p><p id="-wjjj4m_76">Setting the mask to <code class="code" id="-wjjj4m_104">15</code> (<code class="code" id="-wjjj4m_105">0b1111</code>) enables override control only for these first four channels. If you want to override additional channels &mdash; for example, AUX3 &mdash; you need to set the corresponding bit to <code class="code" id="-wjjj4m_106">1</code> as well. In this case, the mask would become <code class="code" id="-wjjj4m_107">79</code> (<code class="code" id="-wjjj4m_108">0b01001111</code>), allowing control over roll, pitch, yaw, throttle and AUX3.</p><p id="-wjjj4m_77">To summarize: <code class="code" id="-wjjj4m_109">15</code> (binary <code class="code" id="-wjjj4m_110">0000000000001111</code>) &rarr; Only channels 0&ndash;3 (roll, pitch, yaw, throttle) are overridden. <code class="code" id="-wjjj4m_111">79</code> (binary <code class="code" id="-wjjj4m_112">0000000001001111</code>) &rarr; Channels 0&ndash;3 and channel 6 (AUX3) are overridden.</p><p id="-wjjj4m_78">You can customize the <code class="code" id="-wjjj4m_113">msp_override_channels_mask</code> by setting the corresponding bits for each channel you want to control from the Pi.</p></section><section class="chapter"><h2 id="co-pilot-flight-logic" data-toc="co-pilot-flight-logic">Co-Pilot Flight Logic</h2><section class="chapter"><h3 id="stable-mode" data-toc="stable-mode">Stable Mode</h3><p id="-wjjj4m_116">When the <code class="code" id="-wjjj4m_122">AUX3</code> channel reads between <code class="code" id="-wjjj4m_123">1400</code> and <code class="code" id="-wjjj4m_124">1900</code>, the Pi activates its &quot;Stable Mode.&quot; In this state, the Pi keeps the drone level by sending neutral RC inputs:</p><p id="-wjjj4m_117"><code class="code" id="-wjjj4m_125">roll = 1500</code></p><p id="-wjjj4m_118"><code class="code" id="-wjjj4m_126">pitch = 1500</code></p><p id="-wjjj4m_119"><code class="code" id="-wjjj4m_127">yaw = 1500</code></p><p id="-wjjj4m_120"><code class="code" id="-wjjj4m_128">throttle = (last known throttle from pilot)</code></p><p id="-wjjj4m_121">This allows the drone to maintain its attitude, assuming it was already stable at the time of mode activation. The Pi does not attempt to recover unstable motion &mdash; it simply holds the current attitude using balanced control inputs.</p></section><section class="chapter"><h3 id="object-detection-and-forward-movement" data-toc="object-detection-and-forward-movement">Object Detection and Forward Movement</h3><p id="-wjjj4m_129">When <code class="code" id="-wjjj4m_132">AUX3</code> exceeds <code class="code" id="-wjjj4m_133">1900</code>, the Pi enters &quot;Object Detection Mode.&quot; It adjusts the drone&rsquo;s behavior as follows:</p><ul class="list _bullet" id="-wjjj4m_130"><li class="list__item" id="-wjjj4m_134"><p id="-wjjj4m_137">Increases throttle slightly (adds <code class="code" id="-wjjj4m_138">+50</code> to the last known throttle input).</p></li><li class="list__item" id="-wjjj4m_135"><p id="-wjjj4m_139">Tilts the drone forward by setting <span class="control" id="-wjjj4m_140">pitch = 1600</span>.</p></li><li class="list__item" id="-wjjj4m_136"><p id="-wjjj4m_141">Uses onboard image recognition to scan for colored objects:</p><ul class="list _bullet" id="-wjjj4m_142"><li class="list__item" id="-wjjj4m_143"><p id="-wjjj4m_146">If a <span class="control" id="-wjjj4m_147">red object</span> is detected &rarr; <span class="control" id="-wjjj4m_148">yaw = 1450</span> (turn left)</p></li><li class="list__item" id="-wjjj4m_144"><p id="-wjjj4m_149">If a <span class="control" id="-wjjj4m_150">blue object</span> is detected &rarr; <span class="control" id="-wjjj4m_151">yaw = 1550</span> (turn right)</p></li><li class="list__item" id="-wjjj4m_145"><p id="-wjjj4m_152">If no object is detected &rarr; <span class="control" id="-wjjj4m_153">yaw = 1500</span> (no turn)</p></li></ul></li></ul><aside class="prompt" data-type="tip" data-title="" id="-wjjj4m_131"><p id="-wjjj4m_154">Important: Avoid switching directly from the lowest AUX3 value (Off Mode) to the highest (Object Detection Mode). Always pass through Stable Mode to ensure smooth transition and stable flight behavior.</p></aside></section></section><div class="last-modified">10 Juli 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="magnet-control-code.html" class="navigation-links__prev">Remote Magnet Control via TCP (Raspberry Pi)</a><a href="object-detection.html" class="navigation-links__next">Object Detection</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>